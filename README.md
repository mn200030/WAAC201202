= WAAC 2012
[2012-12-02 10:55]
# Windows Azure Advent Calender 2日目
今年も早いもので、あっという間に12月になりました。個人的には、Azure Storageのパフォーマンスの向上と新しくなったWindows Azure Storage 2.0が注目です。

# Azure Storageのパフォーマンスの向上
2012/6/7 以降に作成されたストレージアカウントでは、下記のようにパフォーマンスターゲットが引き上げられました。Gen 2と呼ばれているようです。

Azure Table 1Kエンティティの場合
単一パーテーション  500 エンティティ/秒 ->   2,000 エンティティ/秒
複数パーテーション 5,000 エンティティ/秒 -> 20,000 エンティティ/秒 (156Mbps)

http://satonaoki.wordpress.com/2012/11/03/windows-azure%E3%81%AE%E3%83%95%E3%83%A9%E3%83%83%E3%83%88-%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%A82012%E5%B9%B4%E7%89%88%E3%82%B9/


# 確認しよう
早くなったということなので、Azure Storage Client 2.0を使ってGen2のパフォーマンスを確認します。ざっとソースを見た感じだと、従来のコードに比べてシンプルになって速度も期待できそうです。

前記の記事によると、エンティティが1KByteで、複数パーテーションの場合、20,000 エンティティ/秒と言うことです。これだと、単純計算でも156Mbpsのネットワーク速度が必要です。インスタンスは、Mediumだと200 Mbpsの制限がありぎりぎりなのでLarge(400 Mbps)を使うことにします。

LargeだとCoreが8つあるので、CPU的にも足りそうですが、GCをなるべく減らすためにエンティティおデータ部分をCache（共有）します。1KByteぐらいだとあまり効果がないかもしれませんが念のためです。


```C#
Code
```

Threadを上げる数を減らして並列性を上げるために非同期呼び出しを使います。.NET 4.5 から await/async が使えるので割合簡単に非同期コードが記述できるのですが少し手間がかかります。

なんと残念ながら、Windows Azure Storage 2.0になっても APM (Asynchronous Programming Model) のメソッドしか用意されておらず、 await で使えるTaskAsyncの形式がサポートされていません。仕方がないので、自分で拡張メソッドを書きますが、引数が多くて intellisense があっても混乱します。泣く泣く、コンパイルエラーで期待されているシグニチャーをみながら書きました。コードとしてはこんな感じで簡単です。

```C#
Code
```

この辺りは、下記のサイトが詳しくお勧めです。
++C++; // 未確認飛行C 非同期処理
http://ufcpp.net/study/csharp/sp5_async.html#async

このコードを動かしてみたら、「単一スレッド＋非同期の組み合わせだとおおよそ、２から３程度のコネクションしか作成されない」ｌことに気が付きました。場合によっては、5ぐらいまで上がることもあるようですが、どうしてこうなるのか不思議です。

そのため、今回のコードは複数スレッド（Task）をあげて、それぞれのスレッド内で非同期呼び出しを使って処理を行うようになっています。

それでも、1000 

Min.	1st Qu.	Median	Mean	3rd Qu.	Max.	90%	95%	99%
4.561	9.178	12.530	32.580	15.790	4010.000	22.20367	28.62459	950.17083
> 
> 


単一パーテーションで試します


簡単に測定してみます。お題目通りのパフォーマンスが出ておりレイテンシーも10ms未満の数字が出ました。







Image	PID	Local Address	Local Port	Remote Address	Remote Port	Packet Loss (%)	Latency (ms)
TableStress.exe	3132	10.79.106.185	61973	168.62.0.16	80	0	15
TableStress.exe	3132	10.79.106.185	61974	168.62.0.16	80	0	15
TableStress.exe	3132	10.79.106.185	61952	168.62.0.16	80	0	13
TableStress.exe	3132	10.79.106.185	61980	168.62.0.16	80	0	12
TableStress.exe	3132	10.79.106.185	61971	168.62.0.16	80	0	12
TableStress.exe	3132	10.79.106.185	61967	168.62.0.16	80	0	11
TableStress.exe	3132	10.79.106.185	61951	168.62.0.16	80	0	11
TableStress.exe	3132	10.79.106.185	61969	168.62.0.16	80	0	10
TableStress.exe	3132	10.79.106.185	61985	168.62.0.16	80	0	9
TableStress.exe	3132	10.79.106.185	61968	168.62.0.16	80	0	9
TableStress.exe	3132	10.79.106.185	61972	168.62.0.16	80	0	8
TableStress.exe	3132	10.79.106.185	61966	168.62.0.16	80	0	7
TableStress.exe	3132	10.79.106.185	61964	168.62.0.16	80	0	7
TableStress.exe	3132	10.79.106.185	61965	168.62.0.16	80	0	6
TableStress.exe	3132	10.79.106.185	61963	168.62.0.16	80	0	6
TableStress.exe	3132	10.79.106.185	61983	168.62.0.16	80	0	6
TableStress.exe	3132	10.79.106.185	61982	168.62.0.16	80	0	6
TableStress.exe	3132	10.79.106.185	61981	168.62.0.16	80	0	6
TableStress.exe	3132	10.79.106.185	61984	168.62.0.16	80	0	6
TableStress.exe	3132	10.79.106.185	61960	168.62.0.16	80	0	6
TableStress.exe	3132	10.79.106.185	61956	168.62.0.16	80	0	6
TableStress.exe	3132	10.79.106.185	61954	168.62.0.16	80	0	5
TableStress.exe	3132	10.79.106.185	61958	168.62.0.16	80	0	5
TableStress.exe	3132	10.79.106.185	61959	168.62.0.16	80	0	5
TableStress.exe	3132	10.79.106.185	61955	168.62.0.16	80	0	5
TableStress.exe	3132	10.79.106.185	61950	168.62.0.16	80	0	5
TableStress.exe	3132	10.79.106.185	61953	168.62.0.16	80	0	4
TableStress.exe	3132	10.79.106.185	61961	168.62.0.16	80	0	4
TableStress.exe	3132	10.79.106.185	61957	168.62.0.16	80	0	3
TableStress.exe	3132	10.79.106.185	61970	168.62.0.16	80	0	3
TableStress.exe	3132	10.79.106.185	61949	168.62.0.16	80	0	2
TableStress.exe	3132	10.79.106.185	61962	168.62.0.16	80	0	0
TableStress.exe	3132	10.79.106.185	61977	168.62.0.16	80	0	0
TableStress.exe	3132	10.79.106.185	61976	168.62.0.16	80	0	0
TableStress.exe	3132	10.79.106.185	61978	168.62.0.16	80	0	0
TableStress.exe	3132	10.79.106.185	61979	168.62.0.16	80	0	0
TableStress.exe	3132	10.79.106.185	61975	168.62.0.16	80	0	0
TableStress.exe	3132	10.79.106.185	61988	168.62.0.16	80	-	-
TableStress.exe	3132	10.79.106.185	61987	168.62.0.16	80	-	-
TableStress.exe	3132	10.79.106.185	61986	168.62.0.16	80	-	- 

(/ 100000 107671.9539 1000)
